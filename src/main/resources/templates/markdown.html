<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Collaborative Markdown Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        #container {
            display: flex;
            gap: 20px;
        }
        textarea {
            width: 50%;
            height: 400px;
        }
        #preview {
            width: 50%;
            height: 400px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
<h1>Collaborative Markdown Editor</h1>
<div>
    <h1>Edit Markdown</h1>
    <textarea id="markdownInput" th:text="${content}"></textarea> <!-- Inject the content here -->
    <div id="preview"></div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    const token = /*[[${token}]]*/ '';

    console.log("Token:", token);  // Debugging

    if (!token) {
        console.error("Token is missing"); // Stop execution if token is missing
    }

    // WebSocket setup
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
        console.log(`Connected with token: ${token}`);

        // Subscribe to the topic based on the token
        stompClient.subscribe(`/topic/${token}`, function (message) {
            const markdownContent = message.body;

            // Update textarea and preview when a message is received
            const textarea = document.getElementById("markdownInput");
            const preview = document.getElementById("preview");
            textarea.value = markdownContent;
            preview.innerHTML = marked.parse(markdownContent);
        });

        // Send updates to the WebSocket server with the token in headers
        document.getElementById("markdownInput").addEventListener("input", function () {
            const markdownContent = this.value;
            stompClient.send(`/app/edit`, { 'token': token }, markdownContent);
        });
    });

    // Update preview dynamically as the user types
    document.getElementById("markdownInput").addEventListener("input", function () {
        const preview = document.getElementById("preview");
        preview.innerHTML = marked.parse(this.value);
    });
    /*]]>*/
</script>


</body>
</html>

