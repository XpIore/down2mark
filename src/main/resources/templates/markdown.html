<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Collaborative Markdown Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script> <!-- Optional: Add language support -->

    <style>
        #container {
            display: flex;
            gap: 20px;
        }
        textarea {
            width: 50%;
            height: 400px;
        }
        #preview {
            width: 50%;
            height: 400px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        .button-container {
            margin: 10px 0;
        }
        .download-button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .download-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
<h1>Collaborative Markdown Editor</h1>
<div>
    <h2>Edit Markdown</h2>
    <div class="button-container">
        <button onclick="downloadMarkdown()" class="download-button">Download Markdown</button>
        <button onclick="downloadPDF()" class="download-button">Download as PDF</button>
    </div>
    <textarea id="markdownInput" th:text="${content}"></textarea>
    <div id="preview"></div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    async function downloadPDF() {
        const { jsPDF } = window.jspdf; // Ensure jsPDF is loaded
        const markdownText = document.getElementById('markdownInput').value;

        // Convert Markdown to HTML
        const htmlContent = marked.parse(markdownText);

        // Create a container element for rendering
        const tempDiv = document.createElement('div');
        tempDiv.style.width = '800px'; // Ensure consistent width
        tempDiv.style.padding = '10px';
        tempDiv.innerHTML = htmlContent;
        document.body.appendChild(tempDiv);

        // Initialize jsPDF
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'px',
            format: 'a4',
        });

        // Set font style and size
        pdf.setFont("helvetica", "normal"); // Set font family and style (e.g., "normal", "bold", "italic")
        pdf.setFontSize(10); // Adjust the font size (default is 16)

        // Render HTML to PDF
        await pdf.html(tempDiv, {
            callback: function (doc) {
                doc.save('markdown.pdf');
                document.body.removeChild(tempDiv); // Clean up the temporary element
            },
            x: 10,
            y: 10,
            width: 190, // Adjust width to fit content within the PDF
        });
    }



    const token = /*[[${token}]]*/ ''; // Token initialization

    // Add download function
    function downloadMarkdown() {
        const textarea = document.getElementById("markdownInput");
        const content = textarea.value;

        // Create a blob with the markdown content
        const blob = new Blob([content], { type: 'text/markdown' });

        // Create a temporary link element
        const link = document.createElement('a');

        // Create a timestamp for the filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);

        // Set link properties
        link.href = URL.createObjectURL(blob);
        link.download = `markdown-${timestamp}.md`;

        // Append link to body, click it, and remove it
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Clean up the URL object
        URL.revokeObjectURL(link.href);
    }

    console.log("Token:", token);

    if (!token) {
        console.error("Token is missing");
    }

    // WebSocket setup
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
        console.log(`Connected with token: ${token}`);

        stompClient.subscribe(`/topic/${token}`, function (message) {
            const markdownContent = message.body;

            const textarea = document.getElementById("markdownInput");
            const preview = document.getElementById("preview");
            textarea.value = markdownContent;
            preview.innerHTML = marked.parse(markdownContent);
        });

        document.getElementById("markdownInput").addEventListener("input", function () {
            const markdownContent = this.value;
            stompClient.send(`/app/edit`, { 'token': token }, markdownContent);
        });
    });

    document.getElementById("markdownInput").addEventListener("input", function () {
        const preview = document.getElementById("preview");
        preview.innerHTML = marked.parse(this.value);
    });
    /*]]>*/
</script>
</body>
</html>
